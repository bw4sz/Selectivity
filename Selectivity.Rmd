Automated monitoring reveals diverse effects of abiotic and biotic factors on behavioral dominance in Andean Hummingbirds
========================================================

MS prepared for Behavioral Ecology
Ben G. Weinstein, corresponding author, email: bweinste@life.bio.sunsysb.edu

Department of Ecology and Evolution, Stony Brook University, Stony Brook, New York 11794; USA
Catherine H. Graham, email: Catherine.Graham@stonybrook.edu

Department of Ecology and Evolution, Stony Brook University, Stony Brook, New York 11794; USA
Contributions: BW, CG developed the conceptual ideas for the MS; BW collected data, BW conducted the analyses; CG and BW wrote the MS

********

Introduction
-------------

Competition between species may limit local diversity by excluding competitors with similar niche requirements. In addition, it may promote regional diversity, where checkerboard patterns of ecological similar species replace each other across a microclimatic gradient (gottelli and graves). Competition for resources can result in direct interference encounters between species, or exploitation of a common and limited resource. Fundamental tenets of community ecology suggest that closely related, morphologically similar, and aggressive species should compete vigorously for local resources. Where species compete for limited resources species adapted to similar niche requirements will cause local extinctions in subordinate competitors. However, differences in behavior, foraging strategies, and micro-scale distribution allows co-occurrence through fine scale niche diversification

Optimal foraging theory posits that species should feed on most profitable resource available, where an organism evaluates the time needed to extract the resource, versus the value of the resource. Unequal competitive ability among species will lead to reduced visitation to high value patches through interspecific competition. We contrast, abiotic, and biotic predictors of competition through behavioral dominance. Decreased access to high value resources may lead to negative fitness consequences, given the extreme metabolic pressures of hummingbird flight. We offer three, non-exclusive hypothesis, 1) Species should be most selective at the center of their range. Following the abundance center hypothesis, we expect the highest quality territory at the center of species elevation range. Individuals in non-suitable habitat, or weakly suitable habitat, may be inferior competitions due to mal-adaptation to the environment. 2) Species should be most selective when they are the largest (most massive) bird in the competitive community, 3) Species should be most selective when there are many available resources at that elevation.

Hummingbirds are highly specialized nectivorous feeders with adapted morphologies for extracting nectar from hummingbird pollinated flowers. Differences in foraging strategies have important ramifications for species metabolic rate, resource acquisition and mortality (cite). Hummingbird foraging ecology has been extensively studied (Camfield, 2006; P. A. Cotton, 1983; P. a. Cotton, 2006; Feinsinger & Colwell, 1978; González-Gómez, Vásquez, & Bozinovic, 2011; D. R. Powers & Conley, 1994; D. Powers, 1987), and hummingbirds are often partitioned into different syndromes based on their resource use, interspecific aggression and morphology. Feinsinger (1978) partitioned hummingbirds into six ecological roles: marauder, high-reward trapliner, filcher, generalist, territorialist, low-reward trapliner. While these categories are not absolute, and may change over time and space (Feinsinger & Colwell, 1978), they provide an overview for the spectrum of behaviors and associated morphologies, which can be used to categorize hummingbirds in an assemblage. Using these ecological roles, early studies evaluated eco-morphological connections between specific biomechanical flight measures (wing-disc loading, body mass, thrust) and interspecific dominance. For example, wing-disc loading (WDL) is the ratio of mass to wing span, and is a measure of hummingbird agility and thrust (but see Altshuler et al., 2002). Feinsinger and Colwell (1978) predicted that territorial individuals will have high WDL values, which gave them an advantage in flight performance. However, recent work has reexamined the relationship between wing-disc loading and territoriality, and did not support the earlier finding when incorporating phylogenetic interdependence (D. L. Altshuler, 2004). While it is clear that ecological roles are related to morphology (Figure 3), this relationship needs to refined and experimentally tested, especially in a phylogenetic context.

******
Methods
=========
Study Site
-----------
Data was collected at the Maquipicuna Research Station and Santa Lucia Ecolodge (0.11838,-78.61205) between June and August 2013 along an elevation gradient of 1300-2600m. This elevation contains of regenerating secondary and primary cloud-forest, an ecotype dominated by cool year round temperatures, and pronounced  precipitation seasonality, with a warmer dry season (June-Sep) and a cooler rainy season (Jan – May) (Webster and Rhodes 2001). 
Selectivity Experiments
Every 200m of elevation, we placed a feeder with a high value resource (1.2M sucrose), and a low value resource (0.30M sucrose). Feeders were filled and opened for 3 days before filming. The feeders were cleaned, and the nectar was replenished every other day. For each species, selectivity will be measured by dividing the time spent feeding on the high value resource by the total feeding time (D. L. Altshuler, 2004; Pimm, Rosenzweig, & Mitchell, 1985; Sandlin, 2000). We removed selectivity events from very rare visitors to feeders ( > than 1min feeding from 6 hour) 

Time-lapse Cameras
--------------------
We used a novel monitoring technique using time lapse video cameras.  Time lapse cameras (Plotwatcher PRO – Day 6) recorded an image every second, beginning at 6am – 12pm, and 12:30pm to 6pm. Cameras were set at each feeder for a minimum of four days. Comparative analysis with high definition cameras, as well as observer counts showed high fidelity and accuracy in bird identification and timing. Frames were given unique IDs based on date and elevation and stored on terabyte hard-drives until review. Utilizing computer vision libraries in python, we developed motion sensing algorithms to return frames with motion from background frames (OpenCV2 see Appendix A).  Comparative tests with an observer watching an entire video showed no difference between occurrence and species identification. Our pipeline returned the top 10% motion frames within the video, which were then scored by the author and assistant. We recorded all visits to a feeder where we visually could recover the bird actively feeding and noted the duration of feeding, rounded to the nearest 1 second.

Morphological Data
-------------------
For trait information, we used measurements of six traits in adult males: body mass, closed wing-length (i.e., wing chord), and length of exposed culmen, tarsus length, nail length, and wing loading (Graham et al. 2012, Appendix B). We choose these traits from a larger 17 trait datasat because they have a stronger biological basis, and are not highly correlated (Appendix B). Body mass is related to thermoregulatory adaptations to high elevation habitats, as well as aggressive interactions among territorial species (Altshuler and Dudley 2002, González-Gómez et al. 2011). Wing chord is a component of hovering flight, which becomes more difficult at high elevation due to lower air density (Feinsinger and Chaplin 1975). Bill length is associated with resource use through matching between bill lengths and corolla lengths in hummingbird pollinated plants (Temeles et al. 2002). We used principle components analysis on the standardized trait matrix to determine the axis of most variation among species in our assemblage. 

Resource Availability and Use
-----------------------------
To measure available resources we counted the number of hummingbird pollinated plants along six 1km transects along the elevation gradient. Each transect was placed to cover ~200m of elevation change along trails in primary and selectively logged forest. Hummingbird flowering plants were identified by direct observation or by using the well-established morphological syndromes following Backer (1973). For each plant, we estimated the number of total flowers by taking the average flowers on 3-5 stalks, and multiplying by the total number of stalks on a plant. Surveys were repeated twice a month. Flowers were identified using the extensive plant list established for the site, as well as consulting with a number of taxonomic experts (see acknowledgements). Surveys were repeated X times for each elevations over three months.

Hummingbirds Occurrence
--------------------------
To avoid circularity with the selectivity at the feeders, we estimated hummingbird range distribution from independent line transects along the elevation gradient. Observers walked at a slow and consistent pace along the 1km flower transects, only stopping to identify hummingbird species. Where hummingbirds were seen feeding on flowers, we noted the plant species, height and behavior (feeding, defending, piercing, etc.) The maximum and minimum elevation for each hummingbird species were used as the range limits along the elevation gradient. 

**********

```{r, echo=FALSE}
#set global opts
opts_chunk$set(message=FALSE,warning=FALSE,cache=TRUE,echo=FALSE)
```

**What does the data look like?**

```{r,message=FALSE,warning=FALSE,cache=TRUE,echo=FALSE,results='asis'}
################################################################
#Step 1 - Set up data environment and load in data
################################################################

#load in packages
require(ggplot2)
require(chron)
require(reshape)

#set gitpath
gitpath<-"C:/Users/Ben/Documents/Selectivity/"

#source functions
source(paste(gitpath,"functions.R",sep=""))

#Set working directory
droppath<-"C:/Users/Ben/Dropbox/"
setwd(droppath)

##Read in data
dat<-read.csv(paste(droppath,"Thesis//Maquipucuna_SantaLucia/Data2013/csv/CompetitionFeeders.csv",sep=""))

dat$Sex<-toupper(dat$Sex)

#Bring in Hummingbird Morphology Dataset, comes from
hum.morph<-read.csv("Thesis/Maquipucuna_SantaLucia/Results/HummingbirdMorphology.csv",row.names=1)

dat<-dat[,1:12]
require(xtable)
print(xtable(head(dat)),type="html")
```

There are 'r nrow(dat)'rows in the dataset.

**Results**
===================

How many videos have we reviewed for each date and elevation?

```{r,message=FALSE,warning=FALSE,cache=TRUE,echo=FALSE,results='asis'}
#####################################
#Step 2 - Data Cleaning and Sampling
#####################################

#Which dates need to be matched?
vid_totals_date<-aggregate(dat$Video,list(dat$Elevation,dat$Treatment,dat$Date,dat$Replicate),function(x) nlevels(droplevels(x)))
vid_totals_date<-cast(vid_totals_date,Group.1 + Group.3 + Group.4~Group.2)

colnames(vid_totals_date)<-c("Elevation","Date","Replicate(O_R)","High Feeder","Low Feeder")
require(xtable)
print(xtable(vid_totals_date),type="html")
```
Table 1. Number of days of video analyzed for each elevation. For each elevation two sets of high and low value feeders were placed (O or R). The number of videos for each feeder that have been scored for hummingbird selectivity are shown for both the high and low value feeders. 


```{r}

dat<-dat[!dat$Species %in% "UKWN",]

#Create time columns
dat$Time.End<-times(dat$Time.End)
dat$Time.Begin<-times(dat$Time.Begin)

#Find time difference 
dat$Time_Feeder_Obs<-dat$Time.End - dat$Time.Begin

#Get any rownumbers that are negative, these need to be fixed. 
#dat[which(dat$Time_Feeder_Obs < 0),]
```


```{r,message=FALSE,warning=FALSE,cache=TRUE,echo=FALSE}
#average visits per hour
S_H<-table(hours(dat$Time.Begin),dat$Species)

#Create a species list for each video

####Match each trial together, trials are done on the same day at the same elevation
#Split data into a list, with each compenent being one trial pair
Trials<-split(dat, list(dat$Elevation,dat$Date,dat$Replicate),drop=TRUE)

#How many hours of video

#####Just for data clarity remove any trials that down have high and low value data entered
#Get number of levels per trial
levels.trial<-lapply(Trials,function(x) nlevels(factor(x$Treatment)))

#Only use trials that have a high and low, ie levels=2
complete.trial<- Trials[levels.trial ==2]
```

We analyzed 'r sum(sapply(Trials,function(x) nlevels(factor(hours(x$Time.Begin)))))' hours of video through our computer vision pipeline. For each trial the number of seconds feeding, the selectivity for each species, time between feeding bouts, total number of feeding seconds (Appendix A)

```{r,message=FALSE,warning=FALSE,cache=TRUE,results='asis',echo=FALSE}
####Within trial metrics per species

Tdata<-lapply(complete.trial,function(x){
  a<-selective(x)
  b<-bph(x)
  d<-avgF(x)
  dat.trials<-merge(merge(a,b),d)
  Elevation=unique(x$Elevation)
  Date=unique(x$Date)
  Replicate=unique(x$Replicate)
  #Richness at that feeder
  Trichness<-length(levels(droplevels(x$Species)))
  #Total visits
  Tvisits<-nrow(x)
  out<-data.frame(dat.trials,Elevation,Date,Replicate,Richness=Trichness,Tvisits)
  return(out)})

#Bind dataset to a dataframe
selective.matrix<-rbind.fill(Tdata)

selective.matrix$Time_High<-times(selective.matrix$Time_High)
selective.matrix$Time_Low<-times(selective.matrix$Time_Low)
selective.matrix$Total_Time<-selective.matrix$Time_High + selective.matrix$Time_Low

#add total minutes feeding as a weight
selective.matrix$Minutes_High<-minutes(selective.matrix$Time_High) + seconds(selective.matrix$Time_High)/60
selective.matrix$Minutes_Low<-minutes(selective.matrix$Time_Low) + seconds(selective.matrix$Time_Low)/60
selective.matrix$Minutes_Total<-selective.matrix$Minutes_Low+selective.matrix$Minutes_High

#Add month column
selective.matrix$MonthA<-format(as.POSIXct(selective.matrix$Date,format="%m/%d/%Y"),"%b")

#I think i the weighted regression is weird, just take out data where the bird fed less than 

# plot(ecdf(selective.matrix$Minutes_Total))
# 
# ecdf(selective.matrix$Minutes_Total) (1)
# 
# hist(selective.matrix$Minutes_Total,breaks=seq(0,40,.5))
# hist(selective.matrix$Minutes_High,breaks=seq(0,40,.5))
# hist(selective.matrix$Minutes_Low,breaks=seq(0,40,.5))

#Take out birds feeding less than 1min over the 6hours
selective.matrix<-selective.matrix[selective.matrix$Minutes_Total > 1,]
print(xtable(head(selective.matrix)),type="html")

```

***********

Optimal Foraging
===========

```{r,message=FALSE,warning=FALSE,cache=TRUE}
#Birds should prefer high value resources
ggplot(selective.matrix,aes(x=Minutes_High,Minutes_Low)) + geom_point() + geom_abline()

#Optimal foraging says that individuals should occupy patches at a rate equal to their quality
sH<-sum(selective.matrix$Minutes_High)
sL<-sum(selective.matrix$Minutes_Low)

#Optimal foraging says its should be three
print(sH/sL)

#Competition keeps birds from occupying higher quality patch

#Effect of increasing richness on selectivity
ggplot(selective.matrix,aes(x=Richness,y=Selectivity)) + geom_point() + stat_smooth(method="glm",family="binomial",aes(weight=Minutes_Total)) + scale_x_continuous(breaks=seq(0,9,1))

#By species
ggplot(selective.matrix,aes(x=Richness,y=Selectivity)) + geom_point() + stat_smooth(method="glm",family="binomial",aes(weight=Minutes_Total)) + scale_x_continuous(breaks=seq(0,9,1)) + facet_wrap(~Species)

#Effects of increasing visits on selectivity
ggplot(selective.matrix,aes(x=Tvisits,y=Selectivity)) + geom_point() + stat_smooth(method="glm",family="binomial",aes(weight=Minutes_Total))
```


#Correlations among data
------------------------

```{r,message=FALSE,warning=FALSE,cache=TRUE,echo=FALSE}
#pairs plot
ggpairs(selective.matrix[,c("Selectivity","bph","avgF","Elevation","Minutes_High","Minutes_Low","Minutes_Total","MonthA")])

##########################
#merge with morphology
##########################
#PCA of trait space

# Hum Standardized variables, what to do about NA's?
#Standard the matrix to correct for different units by subtracting the means and dividing by sd
zscore <- apply(hum.morph[,c("Bill","Mass","WingChord","Tarsus_Length","Nail_Length","Wing_Loading")], 2, function(x){
  y<-(x - mean(x,na.rm=TRUE))/sd(x,na.rm=TRUE)
  return(y)
})
rownames(zscore)<-hum.morph$English

#Need to figure out what to do about Na's, we could use closely related species?
trait_pc<-prcomp(na.omit(zscore))

#View Biplot of PC Space
biplot(trait_pc)

#bind loadings 1 and 2 to dataframe
hum_load<-trait_pc$x[,c("PC1","PC2")]
rownames(hum_load)<-rownames(zscore)

hum.morph<-merge(hum.morph,hum_load,by.x="English",by.y="row.names")

#merge PCA and original data with selectivity
selective.matrix<-merge(selective.matrix,hum.morph[,!colnames(hum.morph) %in% "Species"],by.x="Species",by.y="English")

#Weighted average of selectivity
ws<-sapply(split(selective.matrix,selective.matrix$Species),function(x){
  weighted.mean(x$Selectivity,x$Total_Time)
})

selective.matrix<-merge(selective.matrix,data.frame(weighted.selectivity=ws),by.x="Species",by.y="row.names")

#average metrics across species
avgStat<-aggregate(selective.matrix[,c("avgF","bph")],by=list(selective.matrix$Species),mean,na.rm=TRUE)
colnames(avgStat)<-c("Species","avgF")

#merge with weighted selectivity
avgStat<-merge(ws,avgStat,by.x="row.names",by.y="Species")
colnames(avgStat)<-c("Species","W.Selectivity","avgF","bph")
rownames(avgStat)<-avgStat$Species

pcaStat<-prcomp(avgStat[,-1],scale=TRUE)
biplot(pcaStat)
```


Hypothesis 1:
------------
Species should be most selective at the center of their range. Following the abundance center hypothesis, we expect the highest quality territory at the center of species elevation range. Individuals in non-suitable habitat, or weakly suitable habitat, may be inferior competitions due to mal-adaptation to the environment.

```{r,message=FALSE,warning=FALSE,cache=TRUE}
#get only species that have atleast 2min
sumT<-aggregate(selective.matrix$Minutes_Total,list(selective.matrix$Species),sum)
speciesSkip<-sumT[sumT$x < 2,]$Group.1

#unweighted
p<-ggplot(selective.matrix[!selective.matrix$Species %in% speciesSkip, ],aes(x=as.numeric(Elevation),Selectivity,col=Species)) + geom_point(size=3) + facet_wrap(~Species) + stat_smooth(method="glm",aes(group=1),family="binomial")
ggsave(paste(gitpath,"Figures//Selectivity_Elevation_Unweighted.svg",sep=""),height=8,width=15)

#weighted
p<-ggplot(selective.matrix[!selective.matrix$Species %in% speciesSkip & selective.matrix$Minutes_Total > 1,],aes(x=as.numeric(Elevation),Selectivity,col=Species,size=Minutes_Total)) + geom_point() + facet_wrap(~Species)
p  + stat_smooth(method="glm",family="binomial") + theme_bw() + xlab("Elevation") + scale_x_continuous(breaks=as.numeric(levels(factor(dat$Elevation))))
ggsave(paste(gitpath,"Figures//Selectivity_Elevation_Unweighted.svg",sep=""),height=8,width=15)

# # #weighted and time
# p<-ggplot(selective.matrix[!selective.matrix$Species %in% speciesSkip,],aes(x=as.numeric(Elevation),Selectivity,col=MonthA,size=Minutes_Total)) + geom_point() + facet_wrap(~Species)
# p
# p  + geom_smooth(method="glm",family="binomial",aes(weight=Minutes_Total)) + theme_bw() + xlab("Elevation") + stat_smooth()

## Write selectivity tables to file
write.csv(selective.matrix,paste(droppath,"Thesis//Maquipucuna_SantaLucia/Results/Selectivity/Selectivity_Elevation.csv",sep=""))
```

```{r,message=FALSE,warning=FALSE,cache=TRUE}
#######################################
#Selectivity, Phylogeny and Morphology
#######################################

#Selectivity Descriptors for each species
ggplot(selective.matrix[!selective.matrix$Species %in% speciesSkip,],aes(x=Species,Selectivity)) + geom_boxplot() + theme(axis.text.x=element_text(angle=-90,vjust=-.1))

#aggregate
wss<-aggregate(selective.matrix$weighted.selectivity,by=list(selective.matrix$Species,selective.matrix$PC1,selective.matrix$PC2),mean)
colnames(wss)<-c("Species","PC1","PC2","weighted.selectivity")

biplot(trait_pc)

ggplot(wss,aes(x=PC2,y=weighted.selectivity)) + geom_point() + geom_smooth(method="glm",family="binomial") + geom_text(aes(label=Species),size=2)
ggplot(wss,aes(x=PC1,y=weighted.selectivity)) + geom_point() + geom_smooth(method="glm",family="binomial") + geom_text(aes(label=Species),size=2)

p<-ggplot(selective.matrix,aes(x=PC1,y=Selectivity,size=Minutes_Total,label=Species)) + geom_point() + stat_smooth(method="glm",link="binomial",aes(weight=Minutes_Total))
p

p<-ggplot(selective.matrix,aes(x=PC2,y=Selectivity,size=Minutes_Total,label=Species,col=Species)) + geom_point() + stat_smooth(method="glm",link="binomial",aes(weight=Minutes_Total,group=1))
p

#########################################################
#Selectivity as function of distance to nearest range edge
##########################################################

#Bring in transect data, see Maquipucuna Repo
transect<-read.csv(paste(droppath,"Thesis//Maquipucuna_SantaLucia//Results//HummingbirdTransects//HumTransectRows.csv",sep=""),row.names=1)

#just get summer transect data
head(transect)

levels(transect$Hummingbird.Species)[levels(transect$Hummingbird.Species) %in% c("violet-tailed Slyph","VIolet-tailed Slyph","Violet-tailed Slyph")]<-"Violet-tailed Sylph"
levels(transect$Hummingbird.Species)[levels(transect$Hummingbird.Species) %in% c("Booted Racketail")]<-"Booted Racket-tail"

transect<-transect[transect$Month %in% c(6,7,8),]
dim(transect)

#Range extent for each species
ggplot(transect,aes(x=ele,fill=Hummingbird.Species)) + geom_histogram() + facet_wrap(~Hummingbird.Species)

rangeLim<-aggregate(transect$ele,list(transect$Hummingbird.Species),range,na.rm=TRUE)
rangeLim<-data.frame(rangeLim$Group.1,rangeLim$x)
colnames(rangeLim)<-c("Species","Min","Max")

ggplot(rangeLim,aes(x=Species,ymin=Min,ymax=Max)) + geom_linerange() + coord_flip()

#Distance to range edge for each datapoint
head(dat)

distU<-apply(selective.matrix,1,function(x){
  
  #If species doesn't exist in transect, skip
  if(sum(rangeLim$Species %in% x["Species"])==0) {
    r<-NA
    names(r)<-NA
    return(r)
  }
  
  maxR<-abs(as.numeric(x["Elevation"]) - as.numeric(rangeLim[rangeLim$Species %in% x["Species"],]$Max))
  minR<-abs(as.numeric(x["Elevation"]) - as.numeric(rangeLim[rangeLim$Species %in% x["Species"],]$Min))

    
  if(maxR > minR) {return(data.frame(UP="Dist_Upper",RDist=maxR))}
  if(minR > maxR) {return(data.frame(UP="Dist_Lower",RDist=minR))}
  
})

#append to dataset
selective.matrix<-data.frame(selective.matrix,rbind.fill(distU))

#Selectivity and distance to range edge.
ggplot(selective.matrix,aes(RDist,Selectivity,col=Species)) + geom_point() + stat_smooth(method="glm",family="binomial",aes(weight=Minutes_Total,group=1)) 

##########################################
#Selectivity as a function of body size
##########################################

p<-ggplot(selective.matrix,aes(x=Mass,y=Selectivity,size=Minutes_Total,label=Species,col=Species)) + geom_point() + stat_smooth(method="glm",family="binomial",aes(weight=Minutes_Total,group=1))
p

##########################################
#Selectivity as a function of difference in body size
##########################################

#Species list for each trial.

sp.lists<-sapply(complete.trial,function(x){
  levels(droplevels(x$Species))
})

#get body size lists for each trial
mass.lists<-lapply(sp.lists,function(x){
  hum.morph[hum.morph$English %in% x, "Mass"]
})

#For each row in the selectivity matrix, get the difference to the largest species

#get the species with the max body size at the feeder during that trial
selective.matrix$MassD<-sapply(1:nrow(selective.matrix),function(y){
  
  x<-selective.matrix[y,]
  #find the index in the list
  index<-paste(paste(x["Elevation"],x[["Date"]],sep="."),x[["Replicate"]],sep=".")
  
  mass_T<-mass.lists[names(mass.lists) %in% index]
  
  #mass of the species minus max
  massD<-x[["Mass"]] - max(unlist(mass_T))
  return(massD)})

p<-ggplot(selective.matrix,aes(x=MassD,y=Selectivity,size=Minutes_Total,label=Species,col=Species)) + geom_point() + stat_smooth(method="glm",family="binomial",aes(weight=Minutes_Total,group=1))

#####################################################
#Compare Selectivity to Available Resource
#####################################################

#read in flower totals from FlowerTransects.R
fltransects<-read.csv(paste(droppath,"Thesis/Maquipucuna_SantaLucia/Results/FlowerTransects/CleanedHolgerTransect.csv",sep=""),row.names=1)

fl<-aggregate(fltransects$Total_Flowers,by=list(fltransects$month,fltransects$Elevation.Begin,fltransects$Elevation.End),sum,na.rm=TRUE)

colnames(fl)<-c("Month","Elevation.Begin","Elevation.End","TotalFlowers")

selective.matrix$Resources<-sapply(1:nrow(selective.matrix),function(y){
  
  #get row
  x<-selective.matrix[y,]
  
  #What month
  m<-as.numeric(months(as.character(x$Date)))
  
  #Total flowers at that elevation
  out<-fl[(fl$Elevation.Begin %in% x$Elevation|fl$Elevation.End %in% x$Elevation) & fl$Month %in% m ,]
  
  #Average of the transects above and below
  return(mean(out$TotalFlowers))
  
  })

p<-ggplot(selective.matrix,aes(x=Resources,y=Selectivity,size=Minutes_Total,label=Species,col=Species)) + geom_point() + stat_smooth(method="glm",family="binomial",aes(weight=Minutes_Total,group=1))
p + facet_wrap(~Species)


# ############Quick look at temperature and elevation
# require(scales)
# ggplot(dat,aes(x=chron(Time.Begin),y=Temp,col=factor(Elevation))) + geom_smooth(se=FALSE) + scale_x_chron(format="%H")

#################################
#Species Presence and Time
##################################

#Create overall date stamp
dat$Time_Stamp<-as.POSIXct(chron(dates=as.character(dat$Date),dat$Time.Begin))

#Time and species occurence, facetted by elevation
ggplot(dat,aes(x=strptime(dat$Time.Begin,"%H:%M"),fill=Species)) + geom_histogram(position="dodge") + facet_wrap(~Elevation)
ggsave("Thesis//Maquipucuna_SantaLucia/Results/TimeofDayElevation.svg",height=11,width=8,dpi=300)

#Overall Month_Day and Elevation
ggplot(dat,aes(y=factor(Elevation),x=dat$Time_Stamp,col=Species)) + geom_point(size=3) + scale_x_datetime() + facet_wrap(~Species)
ggsave("Thesis//Maquipucuna_SantaLucia/Results/DateElevation.svg",height=11,width=8,dpi=300)

```

Supplamentary Figures
=====================

```{r,message=FALSE,warning=FALSE,cache=TRUE,echo=FALSE}

#Species richness and identity at each elevation
sp_matrixHL<-(table(dat$Species,dat$Elevation,dat$Treatment) >= 1) * 1

#View species at each elevation and treatment
m.sp_m<-melt(sp_matrixHL)
colnames(m.sp_m)<-c("Species","Elevation","Treatment","Presence")

#turn 0's to NA's just for plotting
m.sp_m[m.sp_m$Presence==0,"Presence"]<-NA

#richness across feeders
p<-ggplot(m.sp_m,aes(y=Species,x=factor(Elevation),fill=as.factor(Presence)))+ geom_tile() + theme_bw() + scale_fill_discrete(na.value="white")
p + labs(fill="Present",x="Elevation")
ggsave(paste(gitpath,"Figures/RangeExtentFeeders.svg",sep=""),dpi=300,height=8,width=11)
```


```{r,message=FALSE,warning=FALSE,cache=TRUE,echo=FALSE}
#Total Time per species
Total_Time_Species<-aggregate(dat$Time_Feeder_Obs,by=list(dat$Species),sum,na.rm=TRUE) 
colnames(Total_Time_Species)<-c("Species","TotalTime")
Total_Time_Species$Time<-minutes(Total_Time_Species$TotalTime)+seconds(Total_Time_Species$TotalTime)/60

ggplot(Total_Time_Species,aes(Species,Time)) + geom_bar() + theme_bw() + ylab("Minutes on Feeders") + theme(axis.text.x=element_text(angle=-90,vjust=-.1))
```

Figure 3. Average duration of feeding event for each species

```{r,message=FALSE,warning=FALSE,cache=TRUE,echo=FALSE}
#mean time feeding bout
Mean_Time_Species<-aggregate(dat$Time_Feeder_Obs,by=list(dat$Species),mean,na.rm=TRUE) 
colnames(Mean_Time_Species)<-c("Species","Mean_Time")
ggplot(Mean_Time_Species,aes(Species,seconds(Mean_Time))) + geom_bar()  + theme_bw() + theme(axis.text.x=element_text(angle=-90)) + ylab("Average Seconds Feeding")

ggplot(dat,aes(x=seconds(Time_Feeder_Obs))) + geom_histogram()  + theme_bw()
ggsave(paste(gitpath,"Figures/Feedingtime.svg",sep=""),dpi=300,height=8,width=11)

```

Appendix A
============
Selective matrix for all trials and species.

```{r,results='asis'}
print(xtable(selective.matrix),type="html")
```